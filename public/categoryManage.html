<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Category Management</title>
    <link rel="stylesheet" href="style_backoffice.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <header class="header">
      <a href="#" class="logo"
        ><img src="img/PS5.png" alt="logo" width="150" height="50"
      /></a>
      <nav class="navbar">
        <div class="dropdown">
          <a
            class="dropdown-toggle"
            href="#"
            role="button"
            id="dropdownMenuLink"
            data-bs-toggle="dropdown"
          >
            ADMIN
          </a>

          <ul class="dropdown-menu" aria-labelledby="dropdownMenu2">
            <li><a class="dropdown-item" href="#">Category Management</a></li>
            <li>
              <a class="dropdown-item" href="./productManage.html"
                >Product Management</a
              >
            </li>
            <li>
              <a class="dropdown-item" href="./saleHistory.html"
                >Sales History</a
              >
            </li>
          </ul>
        </div>
        <a href="sign_up.html">LOG OUT</a>
      </nav>
    </header>

    <!-- headline -->
    <div class="headline-container">
      <h1 class="headline fw-bold">Category Management</h1>
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCategoryModal">+</button>
  </div>

  <!-- Bootstrap Modal for Adding Category -->
  <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCategoryModalLabel">Add Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addCategoryForm">
            <div class="mb-3">
              <label for="addCategoryName" class="form-label">Category Name</label>
              <input type="text" class="form-control" id="addCategoryName" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="addCategoryBtn">Add Category</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Category List -->
  <div id="categoryList"></div>


    <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editCategoryForm">
              <div class="mb-3">
                <label for="editCategoryName" class="form-label">Category Name</label>
                <input type="text" class="form-control" id="editCategoryName" required>
              </div>
              <input type="hidden" id="editCategoryId">
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="saveChangesBtn">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Modal for Deleting Category -->
    <div class="modal" tabindex="-1" role="dialog" id="confirmDeleteModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this item?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>    

  
    <!-- Console Categories 
    <div class="product-container">
      <h2 class="headline-product fw-bolder">Console</h2>
      <button class="btn btn-secondary">Edit</button>
      <button class="btn btn-danger">Delete</button>
    </div>
    <h2 class="text-product">Playstation Console</h2>
    <div class="row row-cols-4">
      <img src="/img/ps_g1.jpg" class="col mb-4" />
      <img src="/img/ps_g2.jpg" class="col mb-4" />
      <img src="/img/ps_g3.jpg" class="col mb-4" />
      <img src="/img/ps_g4.jpg" class="col mb-4" />
      <img src="/img/G4.jpg" class="col mb-4" />
    </div>

    <h2 class="text-product">Nintendo Console</h2>
    <div class="row row-cols-4">
      <img src="/img/nin_g1.jpg" class="col mb-4" />
      <img src="/img/nin_g2.jpg" class="col mb-4" />
      <img src="/img/nin_g3.jpg" class="col mb-4" />
      <img src="/img/nin_g4.jpg" class="col mb-4" />
    </div>


    Game Categories
    <div class="product-container">
      <h2 class="headline-product fw-bolder">Game</h2>
      <button class="btn btn-secondary">Edit</button>
      <button class="btn btn-danger">Delete</button>
    </div>
    <h2 class="text-product">Playstation Games</h2>
    <div class="row row-cols-4">
      <img src="/img/ps_g1.jpg" class="col mb-4" />
      <img src="/img/ps_g2.jpg" class="col mb-4" />
      <img src="/img/ps_g3.jpg" class="col mb-4" />
      <img src="/img/ps_g4.jpg" class="col mb-4" />
      <img src="/img/G4.jpg" class="col mb-4" />
    </div>

    <h2 class="text-product">Nintendo Games</h2>
    <div class="row row-cols-4">
      <img src="/img/nin_g1.jpg" class="col mb-4" />
      <img src="/img/nin_g2.jpg" class="col mb-4" />
      <img src="/img/nin_g3.jpg" class="col mb-4" />
      <img src="/img/nin_g4.jpg" class="col mb-4" />
    </div>
    

    Acessories Categories -->
    <!-- <div class="product-container">
      <h2 class="headline-product fw-bolder">Acessories</h2>
      <button class="btn btn-secondary">Edit</button>
      <button class="btn btn-danger">Delete</button>
    </div>
    <h2 class="text-product">Playstation Acessories</h2>
    <div class="row row-cols-4">
      <img src="/img/ps_headphone.jpg" class="col mb-4" />
      <img src="/img/ps_joystick.jpg" class="col mb-4" />
      <img src="/img/ps_wheel.jpg" class="col mb-4" />
    </div>

    <h2 class="text-product">Nintendo Acessories</h2>
    <div class="row row-cols-4">
      <img src="/img/nin_wheel.jpg" class="col mb-4" />
      <img src="/img/nin_joycon.jpg" class="col mb-4" />
      <img src="/img/nin_joy.jpg" class="col mb-4" />
      <img src="/img/nin_g4.jpg" class="col mb-4" />
    </div> -->

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
      src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

      <script>
        function openEditModal(categoryId, categoryName) {
          document.getElementById('editCategoryId').value = categoryId;
          document.getElementById('editCategoryName').value = categoryName;
          const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
          modal.show();
        }
  
        
        // function openDeleteModal(categoryId) {
        //   $('#deleteCategoryModal').modal('show');
        //   $('#confirmDeleteBtn').on('click', function() {
        //     deleteCategory(categoryId);
        //   });
        // }

    
        // function addDeleteEventListeners() {
        //   document.querySelectorAll('.btn-danger').forEach(button => {
        //     button.addEventListener('click', function() {
        //       const categoryId = this.dataset.categoryId;
        //       openDeleteModal(categoryId);
        //     });
        //   });
        // }

        // document.getElementById('delete-btn').addEventListener('click', function() {
        //     const categoryId = document.getElementById('category-id').value; // รับค่า ID จาก input หรือ element อื่น ๆ
        //     deleteCategory(categoryId); // เรียกใช้ฟังก์ชัน deleteCategory โดยส่ง categoryId ไป
        // });


        // function deleteCategory(categoryId) {
        //   console.log('Attempting to delete category with ID:', categoryId);
        //   fetch(`/api/deleteCategory/${categoryId}`, {
        //     method: 'DELETE'
        // })
        // .then(response => {
        //     if (!response.ok) {
        //         throw new Error('Failed to delete category');
        //     }
        //     console.log('Category deleted successfully');
        //     location.reload(); // รีเฟรชหน้าเว็บหลังจากการลบสำเร็จ
        // })
        // .catch(error => {
        //     console.error('Error deleting category:', error);
        // });
        // }

        function openDeleteModal(categoryId) {
    // เรียกใช้ Modal เพื่อยืนยันการลบ category
    const confirmDeleteModal = document.getElementById('confirmDeleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

    // เมื่อปุ่ม "Delete" ใน modal ถูกคลิก
    confirmDeleteBtn.addEventListener('click', function() {
        // ทำการลบ category โดยส่ง categoryId ไปยัง API หรือฟังก์ชันบนเซิร์ฟเวอร์
        fetch(`/api/deleteCategory/${categoryId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete category');
            }
            console.log('Category deleted successfully');
            // หลังจากลบสำเร็จ ปิด modal
            confirmDeleteModal.style.display = 'none';
            // รีเฟรชหน้าหลังจากการลบสำเร็จ
            location.reload();
        })
        .catch(error => {
            console.error('Error deleting category:', error);
        });
    });

    // เมื่อ modal ถูกเปิด กำหนดค่าของ categoryId ไปยัง data attribute ของปุ่ม "Delete" ใน modal
    confirmDeleteModal.addEventListener('show.bs.modal', function() {
        confirmDeleteBtn.dataset.categoryId = categoryId;
    });

    // เปิด modal สำหรับยืนยันการลบ
    $('#confirmDeleteModal').modal('show');
}

// ส่งคำขอเพิ่มหมวดหมู่และรับไอดีของหมวดหมู่ที่เพิ่มล่าสุด
function addCategory(categoryName) {
    fetch('/api/addCategory', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ category_name: categoryName })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to add category');
        }
        // หลังจากเพิ่มสำเร็จ แปลง response เป็น JSON
        return response.json();
    })
    .then(data => {
        // เมื่อได้รับไอดีของหมวดหมู่ที่เพิ่มสำเร็จแล้ว ให้เรียกใช้งาน openDeleteModal เพื่อเปิด Modal ลบหมวดหมู่
        openDeleteModal(data.categoryId);
    })
    .catch(error => {
        console.error('Error adding category:', error);
    });
}

// เมื่อหน้าเว็บโหลดเสร็จ เรียกใช้งาน addDeleteEventListeners เพื่อเพิ่ม event listeners ให้กับปุ่ม "Delete"
document.addEventListener('DOMContentLoaded', addDeleteEventListeners);

function addDeleteEventListeners() {
    document.querySelectorAll('.btn-danger').forEach(button => {
        button.addEventListener('click', function() {
            const categoryId = this.dataset.categoryId;
            openDeleteModal(categoryId);
        });
    });
}

        document.addEventListener("DOMContentLoaded", function () {
          // Fetch categories from API endpoint
          fetch('/api/categories')
            .then(response => response.json())
            .then(categories => {
              const categoryList = document.getElementById('categoryList');
              categories.forEach(category => {
                const categoryContainer = document.createElement('div');
                categoryContainer.classList.add('product-container');
                categoryContainer.innerHTML = `
                  <h2 class="headline-product fw-bolder">${category.category_name}</h2>
                  <button class="btn btn-secondary" data-category-id="${category.id}" data-category-name="${category.category_name}">Edit</button>
                  <button class="btn btn-danger" data-category-id="${category.id}">Delete</button>
                `;
                categoryList.appendChild(categoryContainer);
              });
      
              // Add event listeners to delete buttons after creating them
              addDeleteEventListeners();
            })
            .catch(error => console.error('Error loading categories:', error));
      
          // Handle "Add Category" button click event
          document.getElementById('addCategoryBtn').addEventListener('click', function() {
            const categoryName = document.getElementById('addCategoryName').value;
            // Call API to add new category
            fetch('/api/addCategory', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ category_name: categoryName })
            })
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to add category');
              }
              // Reload the page to display new data after adding category successfully
              window.location.reload();
            })
            .catch(error => {
              console.error('Error adding category:', error);
            });
          });
        });
      </script>
      
  </body>
</html>
